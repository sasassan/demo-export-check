name: Publish from Issue
on:
  issues:
    types: [opened, edited, closed, reopened, labeled]

permissions:
  contents: write
  issues: read

jobs:
  publish:
    if: contains(github.event.issue.labels.*.name, 'publish') && github.event.issue.state == 'closed'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Prepare content
        id: prep
        run: |
          TITLE_RAW="${{ github.event.issue.title }}"
          TITLE_SLUG="$(echo "$TITLE_RAW" | sed -e 's/[ ]\+/-/g' -e 's/[^a-zA-Z0-9-_]//g' | tr 'A-Z' 'a-z')"
          SLUG="${TITLE_SLUG:-post-${{ github.event.issue.number }}}"
          DATE="$(date -u +%F)"
          FILE="content/${SLUG}.mdx"
          echo "slug=$SLUG" >> $GITHUB_OUTPUT
          {
            echo '---'
            echo "title: $TITLE_RAW"
            echo "slug: $SLUG"
            echo "date: $DATE"
            echo '---'
            echo
            printf "%s\n" "${{ github.event.issue.body }}"
          } > "$FILE"

      - name: Commit & Push
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add content/
          git commit -m "chore: publish from issue #${{ github.event.issue.number }}" || exit 0
          git push
